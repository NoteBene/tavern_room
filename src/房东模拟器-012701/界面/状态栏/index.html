<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>æˆ¿ä¸œ - ä»ªè¡¨é¢æ¿</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <style>
      :root {
        --primary-yellow: #ffd700; /* ä¸»é»„è‰²ï¼Œç”¨äºæˆ¿å®¢æ ‡ç­¾ */
        --primary-brown: #8b4513; /* ä¸»æ£•è‰²ï¼Œç”¨äºé“å…·ç­‰æ ‡ç­¾ */
        --light-yellow: #fff8dc; /* æµ…é»„è‰²ï¼Œç”¨äºæˆ¿é—´æŒ‰é’® */
        --cream-bg: #faf3e0; /* ç±³é»„è‰²èƒŒæ™¯ */
        --cream-dark: #f5e6ca; /* ç¨æ·±çš„ç±³é»„ */
        --cream-darker: #e8d9b5; /* æ›´æ·±çš„ç±³é»„ */
        --text-dark: #5d4037; /* æ·±è‰²æ–‡å­— */
        --accent-gold: #d4af37; /* é‡‘è‰²å¼ºè°ƒè‰² */
        --border-light: #d7ccc8; /* æµ…è‰²è¾¹æ¡† */
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
        background: var(--cream-bg);
        color: var(--text-dark);
        margin: 0;
        padding: 6px;
        min-height: 100vh;
      }

      .card {
        max-width: 980px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        padding: 12px 8px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        border: 1px solid var(--border-light);
      }

      .top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 6px;
        padding: 6px 0;
        border-bottom: 1px solid var(--border-light);
        margin-bottom: 8px;
      }

      .time {
        color: #795548;
        font-size: 12px;
        font-weight: 500;
      }

      .top-stats {
        display: flex;
        gap: 6px;
      }

      .stat {
        background: var(--cream-dark);
        border: 1px solid var(--border-light);
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 10px;
        color: var(--text-dark);
        min-width: 80px;
        text-align: center;
      }

      .stat strong {
        color: var(--primary-brown);
        font-size: 11px;
      }

      .tabs {
        display: flex;
        gap: 8px;
        margin: 8px 0;
        padding-bottom: 2px;
        border-bottom: 1px solid var(--border-light);
      }

      .tabs button {
        padding: 6px 12px;
        border-radius: 6px;
        border: 2px solid transparent;
        background: var(--cream-dark);
        color: var(--text-dark);
        cursor: pointer;
        font-size: 12px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 4px;
        transition: all 0.2s;
      }

      .tabs button:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .tabs button.active {
        color: white;
        border-color: var(--accent-gold);
        box-shadow: 0 2px 4px rgba(212, 175, 55, 0.2);
      }

      .tabs button:nth-child(1).active {
        /* æˆ¿å®¢ */
        background: var(--primary-yellow);
        color: #5d4037;
      }

      .tabs button:nth-child(2).active {
        /* é“å…· */
        background: #8b4513;
      }

      .tabs button:nth-child(3).active {
        /* ç›‘æ§ */
        background: #2e7d32;
      }

      .tabs button:nth-child(4).active {
        /* äº‹åŠ¡ */
        background: #1565c0;
      }

      .room-tabs {
        display: flex;
        gap: 4px;
        margin-bottom: 4px;
        flex-wrap: wrap;
      }

      .room-tabs button {
        padding: 4px 4px;
        border-radius: 4px;
        border: 1px solid var(--border-light);
        background: var(--light-yellow);
        color: var(--text-dark);
        cursor: pointer;
        font-size: 10px;
        transition: all 0.2s;
        min-width: 30px;
        text-align: center;
      }

      .room-tabs button:hover {
        background: #ffecb3;
      }

      .room-tabs button.active {
        background: var(--primary-yellow);
        border-color: var(--accent-gold);
        font-weight: 600;
        box-shadow: 0 1px 3px rgba(255, 215, 0, 0.3);
      }

      .guest-panel {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .guest-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 8px;
      }

      .guest-name {
        font-size: 16px;
        font-weight: bold;
        color: #5d4037;
        border-bottom: 2px solid var(--cream-dark);
        padding-bottom: 4px;
      }

      .char-portrait {
        width: 64px;
        height: 64px;
        flex: 0 0 64px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        border-radius: 6px;
        border: 1px solid var(--border-light);
        background: white;
      }

      .char-portrait img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }

      .progress-row {
        display: flex;
        gap: 8px;
      }

      /* æ¯ä¸€é¡¹æ¨ªæ’ï¼šæ ‡ç­¾ | è¿›åº¦æ¡ï¼ˆä¼¸ç¼©ï¼‰ | æ•°å€¼ */
      .progress-item {
        flex: 1;
        min-width: 100px;
        background: var(--cream-dark);
        padding: 8px;
        border-radius: 6px;
        border: 1px solid var(--border-light);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .progress-label {
        font-size: 11px;
        color: #795548;
        font-weight: 500;
        width: 64px;
        flex: 0 0 64px;
      }

      .progress-value {
        font-size: 14px;
        font-weight: bold;
        color: var(--primary-brown);
        width: 48px;
        text-align: right;
        flex: 0 0 48px;
      }

      .bar {
        height: 8px;
        background: #e0e0e0;
        border-radius: 4px;
        overflow: hidden;
        flex: 1 1 auto;
      }

      .bar > i {
        display: block;
        height: 100%;
        background: linear-gradient(to right, #4caf50, #8bc34a);
        transition: width 0.5s ease;
      }

      .bar.warn > i {
        background: linear-gradient(to right, #f44336, #ff9800);
      }

      .cards {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .card-block {
        flex: 1;
        min-width: 180px;
        background: var(--cream-dark);
        padding: 0 4px;
        border-radius: 8px;
        border: 1px solid var(--border-light);
      }

      .card-block h4 {
        margin: 2px 0 6px 0;
        padding: 0;
        color: var(--text-dark);
        font-size: 13px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
      }

      .collapsible-header {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .collapse-icon {
        transition: transform 0.3s;
        font-size: 6px;
        color: #795548;
        margin-right: 2px;
      }

      .collapsed .collapse-icon {
        transform: rotate(-90deg);
      }

      .card-content {
        overflow: hidden;
        transition: max-height 0.3s ease;
      }

      .collapsed + .card-content {
        max-height: 0;
      }

      .card-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 6px;
        margin-top: 6px;
      }

      .card-item {
        background: white;
        padding: 6px;
        border-radius: 4px;
        border: 1px solid var(--border-light);
        font-size: 10px;
      }

      .card-item strong {
        color: var(--primary-brown);
        display: block;
        font-size: 9px;
        margin-bottom: 2px;
      }

      .list-cards {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .list-cards .card-block {
        width: 180px;
      }

      .empty-room,
      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #795548;
        font-size: 12px;
        background: var(--cream-dark);
        border-radius: 8px;
        border: 1px dashed var(--border-light);
        margin: 10px 0;
      }

      .empty-room::before,
      .empty-state::before {
        display: block;
        font-size: 32px;
        margin-bottom: 12px;
        opacity: 0.6;
      }

      .empty-room::before {
        content: 'ğŸ '; /* æˆ¿é—´å›¾æ ‡ */
      }

      .tab-icon {
        font-size: 12px;
      }

      .empty-state[data-type='props']::before {
        content: 'ğŸ’'; /* èƒŒåŒ…å›¾æ ‡ */
      }

      .empty-state[data-type='monitor']::before {
        content: 'ğŸ“¹'; /* æ‘„åƒæœºå›¾æ ‡ */
      }

      .empty-state[data-type='tasks']::before {
        content: 'ğŸ“‹'; /* è®°äº‹æœ¬å›¾æ ‡ */
      }

      .guest-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 8px;
        margin-top: 8px;
        font-size: 11px;
      }

      .guest-info > div {
        background: var(--cream-dark);
        padding: 6px 10px;
        border-radius: 4px;
        border: 1px solid var(--border-light);
      }

      .guest-info strong {
        color: var(--primary-brown);
      }

      @media (max-width: 640px) {
        .card {
          padding: 8px 6px;
        }
        .card-grid {
          grid-template-columns: repeat(2, 1fr);
        }
        .cards {
          flex-direction: column;
        }
        .card-block {
          min-width: 100%;
        }
        .list-cards .card-block {
          width: 100%;
        }
        .top {
          flex-direction: column;
          align-items: flex-start;
          gap: 6px;
        }
        .top-stats {
          width: 100%;
          justify-content: space-between;
          flex-wrap: wrap;
        }
        .stat {
          flex: 1;
          min-width: 100px;
        }
        .tabs {
          flex-wrap: wrap;
        }
        .tabs button {
          flex: 1;
          justify-content: center;
        }
        .progress-row {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body>
    <div id="app" class="card">
      <div class="top">
        <div>
          <div class="time">{{ stat['å½“å‰æ—¶é—´'] || 'â€”' }}</div>
        </div>
        <div class="top-stats">
          <div class="stat">èµ„é‡‘: <strong>{{ stat['ä¸»è§’èµ„é‡‘'] ?? 'â€”' }}</strong></div>
          <div class="stat">å…¬å¯“çŸ¥ååº¦: <strong>{{ stat['å…¬å¯“çŸ¥ååº¦'] ?? 'â€”' }}</strong></div>
          <div class="stat">é…’å§çŸ¥ååº¦: <strong>{{ stat['é…’å§çŸ¥ååº¦'] ?? 'â€”' }}</strong></div>
        </div>
      </div>

      <div class="tabs" role="tablist">
        <button :class="{active:tab==='æˆ¿å®¢'}" @click="tab='æˆ¿å®¢'">
          <span class="tab-icon">ğŸ‘¥</span>
        </button>
        <button :class="{active:tab==='é“å…·'}" @click="tab='é“å…·'">
          <span class="tab-icon">ğŸ®</span>
        </button>
        <button :class="{active:tab==='ç›‘æ§'}" @click="tab='ç›‘æ§'">
          <span class="tab-icon">ğŸ“±</span>
        </button>
        <button :class="{active:tab==='äº‹åŠ¡'}" @click="tab='äº‹åŠ¡'">
          <span class="tab-icon">ğŸ“…</span>
        </button>
      </div>

      <div v-if="tab==='æˆ¿å®¢'">
        <div class="room-tabs">
          <button v-for="r in rooms" :key="r" :class="{active:activeRoom===r}" @click="setRoom(r)">{{ r }}</button>
        </div>

        <div id="room-content">
          <div v-if="guest" class="guest-panel">
            <div class="guest-header">
              <div class="char-portrait">
                <img v-if="portraitSrc" :src="portraitSrc" :alt="guestName" />
              </div>
              <div class="guest-name">{{ guestName }}</div>
            </div>

            <div class="progress-row">
              <div class="progress-item">
                <div class="progress-label">å¥½æ„Ÿåº¦</div>
                <div class="bar"><i :style="{width: (guest.å¥½æ„Ÿåº¦||0) + '%'}"></i></div>
                <div class="progress-value">{{ guest.å¥½æ„Ÿåº¦ ?? 0 }}</div>
              </div>

              <div class="progress-item">
                <div class="progress-label">å •è½åº¦</div>
                <div class="bar warn"><i :style="{width: (guest.å •è½åº¦||0) + '%'}"></i></div>
                <div class="progress-value">{{ guest.å •è½åº¦ ?? 0 }}</div>
              </div>
            </div>

            <div class="cards">
              <div class="card-block">
                <h4 :class="{collapsed: isBasicCollapsed}" @click="toggleCollapse('basic')">
                  <span class="collapsible-header">
                    <span class="collapse-icon">â–¼</span>
                    åŸºæœ¬ä¿¡æ¯
                  </span>
                </h4>
                <div class="card-content" :style="{maxHeight: isBasicCollapsed ? '0px' : '500px'}">
                  <div class="card-grid">
                    <div class="card-item" v-for="k in basicKeys" :key="k">
                      <strong>{{ k }}</strong>
                      <div>{{ (guest['åŸºæœ¬ä¿¡æ¯'] && guest['åŸºæœ¬ä¿¡æ¯'][k]) ?? 'â€”' }}</div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="card-block">
                <h4 :class="{collapsed: isOutfitCollapsed}" @click="toggleCollapse('outfit')">
                  <span class="collapsible-header">
                    <span class="collapse-icon">â–¼</span>
                    ç€è£…
                  </span>
                </h4>
                <div class="card-content" :style="{maxHeight: isOutfitCollapsed ? '0px' : '500px'}">
                  <div class="card-grid">
                    <div class="card-item" v-for="k in outfitKeys" :key="k">
                      <strong>{{ k }}</strong>
                      <div>{{ (guest['ç€è£…'] && guest['ç€è£…'][k]) ?? 'â€”' }}</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="guest-info">
              <div>å½“å‰å¿ƒæƒ…: <strong>{{ guest['å½“å‰å¿ƒæƒ…'] ?? 'â€”' }}</strong></div>
              <div>æ­£åœ¨å¹²å˜›: <strong>{{ guest['æ­£åœ¨å¹²å˜›'] ?? 'â€”' }}</strong></div>
              <div>å½“å‰è®¡åˆ’: <strong>{{ guest['å½“å‰è®¡åˆ’'] ?? 'â€”' }}</strong></div>
            </div>
          </div>
          <div v-else class="empty-room">æˆ¿é—´æš‚æ— æˆ¿å®¢</div>
        </div>
      </div>

      <div v-if="tab==='é“å…·'">
        <div v-if="Object.keys(items).length === 0" class="empty-state" data-type="props">èƒŒåŒ…ç©ºç©ºå¦‚ä¹Ÿ</div>
        <div v-else class="list-cards">
          <div class="card-block" v-for="(it,k) in items" :key="k">
            <h4>{{ k }}</h4>
            <div>{{ it['æè¿°'] ?? it['description'] ?? 'â€”' }}</div>
            <div>æ•°é‡: {{ it['æ•°é‡'] ?? it['count'] ?? 'â€”' }}</div>
          </div>
        </div>
      </div>

      <div v-if="tab==='ç›‘æ§'">
        <div v-if="Object.keys(monitors).length === 0" class="empty-state" data-type="monitor">æš‚æ— ç›‘æ§è®¾å¤‡</div>
        <div v-else class="list-cards">
          <div class="card-block" v-for="(v,k) in monitors" :key="k">
            <h4>{{ k }}</h4>
            <div>{{ v }}</div>
          </div>
        </div>
      </div>

      <div v-if="tab==='äº‹åŠ¡'">
        <div v-if="tasks.length === 0" class="empty-state" data-type="tasks">æš‚æ— å¾…å¤„ç†äº‹åŠ¡</div>
        <div v-else class="list-cards">
          <div class="card-block" v-for="(t,idx) in tasks" :key="idx">
            <div>{{ t }}</div>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      const { createApp, ref, computed, onMounted } = Vue;

      function _getGlobal(name) {
        return window[name];
      }
      function getAllVariables() {
        return typeof _getGlobal('getAllVariables') === 'function'
          ? _getGlobal('getAllVariables')()
          : window.__mock_variables || {};
      }
      async function waitInit() {
        const f = _getGlobal('waitGlobalInitialized');
        if (typeof f === 'function') await f('Mvu');
      }

      createApp({
        setup() {
          const tab = ref('æˆ¿å®¢');
          const rooms = ['201', '202', '203', '204', '205'];
          const activeRoom = ref(rooms[0]);
          const vars = ref(getAllVariables());
          const stat = computed(() => vars.value.stat_data || {});

          // æŠ˜å çŠ¶æ€
          const isBasicCollapsed = ref(true);
          const isOutfitCollapsed = ref(true);

          function setRoom(r) {
            activeRoom.value = r;
          }

          function toggleCollapse(type) {
            if (type === 'basic') {
              isBasicCollapsed.value = !isBasicCollapsed.value;
            } else if (type === 'outfit') {
              isOutfitCollapsed.value = !isOutfitCollapsed.value;
            }
          }

          const guestNames = computed(() => Object.keys(stat.value['æˆ¿å®¢'] || {}));
          const guestIndex = computed(() => rooms.indexOf(activeRoom.value));
          const guestName = computed(() => guestNames.value[guestIndex.value] || null);
          const guest = computed(() => (guestName.value ? stat.value['æˆ¿å®¢'][guestName.value] : null));

          const portraitSrc = computed(() => {
            if (!guest.value) return null;
            const g = guest.value;
            let cand = g['ç«‹ç»˜'] || g['portrait'] || g['å¤´åƒ'] || g['avatar'] || g['avatarUrl'] || g['image'];
            const name = guestName.value || '';
            // ä½¿ç”¨ jsDelivr CDN ä»¥æé«˜ä¸­å›½å¤§é™†å¯è®¿é—®æ€§ï¼ˆæŒ‡å‘ä»“åº“çš„ img ç›®å½•ï¼‰
            const repoRawBase = 'https://cdn.jsdelivr.net/gh/NoteBene/tavern_room@main/img';

            // è‹¥ä¸ºæ•°ç»„ï¼Œåˆ™å–ç¬¬ä¸€é¡¹ï¼›ç¡®ä¿ä¸ºå­—ç¬¦ä¸²
            if (Array.isArray(cand)) cand = cand[0];
            if (!cand) {
              // é»˜è®¤ä½¿ç”¨è§’è‰²æ–‡ä»¶å¤¹ä¸­çš„ä¸€å¼ å›¾ç‰‡ï¼ˆç¤ºä¾‹è¦æ±‚é»˜è®¤ä¸º å†…è¡£.jpgï¼‰
              return `${repoRawBase}/${encodeURIComponent(name)}/${encodeURIComponent('å†…è¡£.jpg')}`;
            }
            cand = String(cand).trim();

            // å·²ç»æ˜¯ç»å¯¹ URLï¼Œç›´æ¥è¿”å›
            if (/^https?:\/\//.test(cand)) return cand;

            // å¦‚æœåŒ…å«è·¯å¾„åˆ†éš”ç¬¦ï¼Œå°è¯•æŒ‰ä»“åº“ img è·¯å¾„æ„é€ ï¼ˆå…è®¸ä¼ å…¥ img/è§’è‰²/æ–‡ä»¶.jpg æˆ– è§’è‰²/æ–‡ä»¶.jpgï¼‰
            if (cand.includes('/')) {
              const parts = cand.split('/').filter(Boolean);
              // å¦‚æœä»¥ img å¼€å¤´ï¼Œå»æ‰è¯¥éƒ¨åˆ†
              if (parts[0] === 'img') parts.shift();
              const folder = parts.shift() || name;
              let file = parts.join('/');
              if (!file) {
                // ä¼˜å…ˆä½¿ç”¨æˆ¿å®¢å˜é‡ä¸­çš„ `ç«‹ç»˜` å­—æ®µï¼ˆå…è®¸ï¼šå¸¸æœã€å†…è¡£ã€æƒ…è¶£å†…è¡£ã€è£¸ä½“ã€ç²¾æ¶²ï¼‰
                const lp = (g && g['ç«‹ç»˜']) || 'å†…è¡£';
                file = String(lp || 'å†…è¡£');
                if (!/\.[a-zA-Z0-9]+$/.test(file)) file += '.jpg';
              }
              return `${repoRawBase}/${encodeURIComponent(folder)}/${encodeURIComponent(file)}`;
            }

            // è‹¥ cand æ˜¯å•ä¸ªæ–‡ä»¶åæˆ–ä¸å«æ‰©å±•åï¼Œåˆ™è§†ä½œæ–‡ä»¶åæ”¾åœ¨è§’è‰²æ–‡ä»¶å¤¹ä¸‹
            let filename = cand;
            if (!/\.[a-zA-Z0-9]+$/.test(filename)) filename += '.jpg';
            return `${repoRawBase}/${encodeURIComponent(name)}/${encodeURIComponent(filename)}`;
          });

          const basicKeys = ['ç§æ—', 'ç­‰çº§', 'èº«é«˜', 'ä¸‰å›´', 'ç½©æ¯', 'å¹´é¾„'];
          const outfitKeys = ['ä¸Šè£…', 'ä¸‹è£…', 'å†…è¡£', 'è¢œå­', 'é‹å­', 'é¥°å“'];

          const items = computed(() => stat.value['ç‰©å“æ '] || {});
          const monitors = computed(() => stat.value['å¯ç›‘æ§åŒºåŸŸ'] || {});
          const tasks = computed(() => stat.value['è¿‘æœŸäº‹åŠ¡'] || []);

          onMounted(async () => {
            await waitInit();
            function tick() {
              vars.value = getAllVariables();
            }
            tick();
            setInterval(tick, 2000);
          });

          return {
            tab,
            rooms,
            activeRoom,
            setRoom,
            stat,
            guest,
            guestName,
            portraitSrc,
            basicKeys,
            outfitKeys,
            items,
            monitors,
            tasks,
            isBasicCollapsed,
            isOutfitCollapsed,
            toggleCollapse,
          };
        },
      }).mount('#app');
    </script>
  </body>
</html>
